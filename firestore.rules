rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- Student Data Rules ---
    match /students/{scholarNum} {
      allow create: if request.auth != null
                          && request.resource.data.uid == request.auth.uid
                          && request.resource.id == request.resource.data.scholarNumber;
      allow read: if request.auth != null; // Allow any authenticated user to read student profiles (needed for claimer info)
      allow update, delete: if request.auth != null && (request.auth.uid == resource.data.uid || isAdmin());
    }

    match /students-by-uid/{userId} {
      allow create: if request.auth != null && request.auth.uid == userId;
      // MODIFIED: Allow any authenticated user to read the UID -> scholarNumber mapping
      allow read: if request.auth != null; 
      allow update, delete: if false || isAdmin();
    }

    // --- Posts Rules ---
    match /posts/{postId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update: if request.auth != null && (
          (resource.data.authorId == request.auth.uid || isAdmin()) ||
          (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['upvotesCount', 'downvotesCount']))
       );
      allow delete: if request.auth != null && (resource.data.authorId == request.auth.uid || isAdmin());
    }

    // --- Post Votes Rules ---
    match /post_votes/{voteId} {
      allow get: if request.auth != null && voteId.split('_')[0] == request.auth.uid;
      allow list: if request.auth != null && request.query.userId == request.auth.uid; // Use request.query.userId
      allow read: if request.auth != null && request.auth.uid == resource.data.userId;
      allow create, update: if request.auth != null
         && request.auth.uid == request.resource.data.userId
         && voteId == request.auth.uid + "_" + request.resource.data.postId;
      allow delete: if request.auth != null && resource.data.userId == request.auth.uid;
    }

    // --- Favorite Posts Rules ---
    match /favoritePosts/{favoriteId} {
      allow get: if request.auth != null && favoriteId.split('_')[0] == request.auth.uid;
      allow list: if request.auth != null && request.query.userId == request.auth.uid; // Use request.query.userId
      allow read: if request.auth != null && request.auth.uid == resource.data.userId;
      allow create: if request.auth != null
         && request.auth.uid == request.resource.data.userId
         && favoriteId == request.auth.uid + "_" + request.resource.data.postId;
      allow delete: if request.auth != null && resource.data.userId == request.auth.uid;
    }

    // --- Lost and Found Rules ---
    match /lostAndFound/{itemId} {
      // Allow any authenticated user to read any lost/found item.
      allow read: if request.auth != null;

      // Allow authenticated users to create new lost/found items.
      allow create: if request.auth != null && request.auth.uid == request.resource.data.reporterId;

      // Allow updates based on the action:
      allow update: if request.auth != null && (
          // Reporter confirming a claim
          (resource.data.reporterId == request.auth.uid &&
           request.resource.data.status == 'inactive' && 
           request.resource.data.confirmedClaimer is string && 
           request.resource.data.claimers is list && request.resource.data.claimers.size() == 0
          ) ||
          // Any user claiming/unclaiming
          (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['claimers'])) ||
          // *** NEW: Allow any authenticated user to mark a 'lost' item as 'inactive' when found ***
          (resource.data.type == 'lost' && 
           resource.data.status == 'active' && 
           request.resource.data.status == 'inactive' && 
           request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status'])
          )
      );

      // Allow reporter to delete their own post.
      allow delete: if request.auth != null && resource.data.reporterId == request.auth.uid;
    }

    // Admin collection (example)
    match /admins/{userId} {
      allow read: if true; // Or restrict as needed
    }
  }

  // --- Helper Functions ---
  function isAdmin() {
    // Check if the requesting user's UID exists in the 'admins' collection
    return exists(/databases/$(database)/documents/admins/$(request.auth.uid));
  }
}
